<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="va.main.Deploy">
	<!-- FOR IF ELSE CONDITION TO WORK -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="lib_ext/ant-contrib.jar"/>
        </classpath>
	</taskdef>
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpath="lib_ext/ant-contrib.jar"/>
	
	<taskdef name="classloadertask" classname="org.apache.tools.ant.taskdefs.ClassloaderTask" classpath="lib_ext/ant-classloadertask.jar"/>
	
	<description>Vitalaxis Backup Jenkins Build Script Files Script</description>

    <path id="javax.classpath">
        <pathelement location="lib_ext\groovy-3.0.24.jar" />
        <pathelement location="lib_ext\groovy-jsr223-3.0.24.jar" />
    </path>
    
	<path id="vabuild.library">
        <fileset dir="lib">
            <include name="**/*.jar"/>
        </fileset>
	</path>

	<!-- <classloadertask classpathRef="mail.path" loader="thread"/> -->
	<path id="mail.path">
	    <pathelement location="lib_ext/java-mail-1.4.4.jar"/>
    </path>
	
    <!-- ************************************************************ --> 
	<!-- Sets the touch time that needs to be used for the build. If the param is sent, then an existing folder can be used. -->
	<target name="va.prop.set.touch.time" unless="touch.time">
        <tstamp>
			<format property="touch.time" pattern="yyyyMMddHHmmss" offset="0" unit="hour"/>
		</tstamp>

        <tstamp>
			<format property="Date" pattern="yyyy-MM-dd HH:mm:ss" offset="0" unit="hour"/>
		</tstamp>

        <property environment="env" />
        <property name="Original_Build_Number" value="${env.BUILD_NUMBER}"/>

        <script language="groovy" manager="javax" classpathref="javax.classpath">
            def Build_Number = project.getProperty("Original_Build_Number");
            def Touch_Time = project.getProperty("touch.time");
            if(Build_Number.length() == 1) project.setProperty("Build_Id", (("00" + Build_Number) + '_' + Touch_Time));
            else if(Build_Number.length() == 2) project.setProperty("Build_Id", (("0" + Build_Number) + '_' + Touch_Time));
            else project.setProperty("Build_Id", (Build_Number + '_' + Touch_Time));
        </script>
	</target>


	<!-- Display Input values -->
	<target name="va.display.input.values">
		<echo>*********************************** Inputs ***********************************</echo>
		<echo>Build_Id		=	${Build_Id}</echo>
		<echo>Server		=	${Server}</echo>
		<echo>Date		=	${Date}</echo>
		<echo>*****************************************************************************</echo>
	</target>

	
    <!-- ************************************************************ -->	
	<target name="va.configfiles.set.properties">
        <property name="va.configfiles.bin.folder" location="bin" />
        
        <property name="va.configfiles.folder.build.git.version" location="${va.configfiles.bin.folder}\Jenkins_ConfigFiles\DevOps\Configfiles_Categorized_By_Jenkins_Servers\${Server}"/>

        <property name="va.configfiles.folder.configfiles.source" location="\\${Server}\d$\VitalAxis\Websites-IIS"/>
        
        <property name="va.configfiles.folder.configfiles.destination" location="\\${Server}\d$\VitalAxis\Config-Backup"/>
        
		<property name="configfiles.includes"
				value="**\Web.Config,
                        **\web.config,
                        **\Web.config,
                        **\web.Config,
						**\appsettings.json" />

		<property name="configfiles.excludes"
				value="**\*.dll,
						**\*.pdb" />
	</target>

	
    <!-- ************************************************************ -->	
	<target name="va.configfiles.create.folders">
        <mkdir dir="${va.configfiles.folder.build.git.version}" />
	</target>
	
	
    <!-- ************************************************************ -->	
	<target name="va.configfiles.git.pull">
		<echo message="****************************************************************************************"/> 
		<echo message="*********************************** Git Pull ******************************************"/> 
		<echo message="****************************************************************************************"/> 

        <!--
        <exec dir="${va.configfiles.folder.build.git.version}" executable="cmd.exe">
            <arg line="/c git clone -b ${Git_Branch} git@vagit.vitalaxis.com:DevOps/DevOps.git"/>
        </exec>
        -->
        <!--
        <exec dir="${va.configfiles.bin.folder}\Config_Files_Backup" executable="git">
            <arg line="clone -b Config_Files_Backup http://lohith.jayanna:Yy9v4R8WLmuq_xgygE_k@vagit.vitalaxis.com/DevOps/DevOps.git"/>
        </exec> 
        -->
        
        <exec dir="${va.configfiles.bin.folder}\Config_Files_Backup\DevOps" executable="git">
            <arg line="pull"/>
        </exec>

	</target>


    <!-- ************************************************************ -->
    <!-- Copy Config Files -->
	<target name="va.configfiles.copy.configfiles" description="Copy config files">
		<echo message="****************************************************************************************"/> 
		<echo message="******************************* Copy config files ***********************************"/> 
		<echo message="****************************************************************************************"/> 

        <!-- Copy build files to Output folder -->
        <copy todir="${va.configfiles.folder.configfiles.destination}" overwrite="true">
            <fileset dir="${va.configfiles.folder.configfiles.source}" includes="${configfiles.includes}" excludes="${configfiles.excludes}" />
        </copy>

	</target>

    
    <!-- ************************************************************ --> 
	<!-- Push to Config_Files_Backup Branch -->
	<target name="va.configfiles.push">
		<echo message="****************************************************************************************"/> 
		<echo message="**************************** Pushing to Config_Files_Backup Branch ***************************************"/> 
		<echo message="****************************************************************************************"/> 
        
        <echo></echo>

        <echo>Pushing to Config_Files_Backup Branch...</echo>
        <exec dir="${va.configfiles.folder.build.git.version}" executable="git">
            <arg line="add ."/>
        </exec>
        
        <exec dir="${va.configfiles.folder.build.git.version}" executable="git">
            <arg line='commit -m "Updated Config Files as on ${Date}"'/>
        </exec>
        
        <exec dir="${va.configfiles.folder.build.git.version}" executable="git">
            <arg line="push"/>
        </exec>
	</target>


    <!-- ************************************************************ --> 
    <!-- Push to Git -->
	<target name="call.va.Deploy">
        <antcall target="va.configfiles.push"/>
    </target>
    

    <!-- ************************************************************ -->		
	<!-- Main Target. Executes other targets. --> 
	<target name="va.main.Deploy" depends="va.prop.set.touch.time,va.display.input.values,va.configfiles.set.properties,va.configfiles.copy.configfiles">
        <!-- <antcall target="call.va.Deploy"/> -->
    </target>

</project>
