<project name="VitalAxis Deploy Project" default="check.errors">

	<!-- Include To Use for Loop -->
	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
	    	<pathelement location="lib_ext\ant-contrib.jar"/>
		</classpath>
	</taskdef>
	  
  
	<property name="jenkins.email.logs" location="logs\" />

 	<target name="check.errors">

		<exec executable="PowerShell" dir="${jenkins.email.logs}" failonerror="true"> 
			<arg value="$Files = Get-ChildItem;" /> 
			<arg value="foreach($File in $Files){" /> 
			<arg value="	$Content = Get-Content -Raw -Path $File.FullName;" /> 
			<arg value="	if(($Content -match '(?s)^(\s*\(\d+ rows affected\)\s*)+$') -or ($File.Length -eq 0)){" />  
			<arg value="		Remove-Item -Path $File.FullName -Force;" /> 
			<arg value="	}" /> 
			<arg value="}" /> 
		</exec>

		<!-- Throw error if SQL scripts output have errors -->
		<exec executable="PowerShell" dir="${jenkins.email.logs}" failonerror="true"> 
			<arg value="if((Get-ChildItem | ? Name -like '*sql*').Count -gt 0){throw '~~~~~~~~~~~~~~~~~~~~~ Error(s) in DB Scripts ~~~~~~~~~~~~~~~~~~~~~'}" /> 
		</exec>
		
	</target>


	  
  
 	<!--Execute VA WEB scripts in provided server.-->
 	<target name="va.web.deploy.execute.scripts">
		<!-- Execute 01.PRE Folder -->
		<if>
			<available file="${va.web.folder.output.scripts}\01.PRE" type="dir"/>
			<then>
				<fileset id="va.sql.pre.contents" dir="${va.web.folder.output.scripts}\01.PRE" includes="*.sql"/> 
				<property name="va.prop.pre.contents" refid="va.sql.pre.contents"/> 
				
				<for list="${va.prop.pre.contents}" param="sqlFileName" delimiter=";"> 
					<sequential> 
						<exec executable="sqlcmd" output="${va.web.folder.logs}\console_${touch.time}_@{sqlFileName}.log" append="true"> 
							<arg line="-S ${db.servername} -U ${db.username} -P ${db.password} -d ${db.name} -i ${va.web.folder.output.scripts}\01.PRE\@{sqlFileName} -o ${va.web.folder.logs}\@{sqlFileName}.log" /> 
						</exec>	
					</sequential> 
				</for> 
			</then>
		</if>
		
		<!-- Execute Deployment Folder -->
		<if>
			<available file="${va.web.folder.output.scripts}\${Deployment}" type="dir"/>
			<then>
				<fileset id="va.sql.deployment.contents" dir="${va.web.folder.output.scripts}\${Deployment}" includes="*.sql"/> 
				<property name="va.prop.deployment.contents" refid="va.sql.deployment.contents"/> 

				<for list="${va.prop.deployment.contents}" param="sqlFileName" delimiter=";"> 
					<sequential> 
						<exec executable="sqlcmd" output="${va.web.folder.logs}\console_${touch.time}_@{sqlFileName}.log" append="true"> 
							<arg line="-S ${db.servername} -U ${db.username} -P ${db.password} -d ${db.name} -i ${va.web.folder.output.scripts}\${Deployment}\@{sqlFileName} -o ${va.web.folder.logs}\@{sqlFileName}.log" />                            							
					    </exec>	
					</sequential> 
				</for> 
			</then>
		</if>
		
		<!-- Execute Main Folder -->
		<if>
			<available file="${va.web.folder.output.scripts}\02.MAIN\01.functions.sql"/>
			<then>
				<exec executable="sqlcmd" output="${va.web.folder.logs}\console_${touch.time}_functions.log" append="true">  
				<arg line="-S ${db.servername} -U ${db.username} -P ${db.password} -d ${db.name} -i ${va.web.folder.output.scripts}\02.MAIN\01.functions.sql -o ${va.web.folder.logs}\sqlfunctions.log" />
				</exec>	
			</then>        
		</if>
		<if>
			<available file="${va.web.folder.output.scripts}\02.MAIN\02.views.sql"/>
			<then>
				<exec executable="sqlcmd" output="${va.web.folder.logs}\console_${touch.time}_views.log" append="true">  
				<arg line="-S ${db.servername} -U ${db.username} -P ${db.password} -d ${db.name} -i ${va.web.folder.output.scripts}\02.MAIN\02.views.sql -o ${va.web.folder.logs}\sqlviews.log" />
				</exec>	
			</then>        
		</if>
		<if>
			<available file="${va.web.folder.output.scripts}\02.MAIN\03.procedures.sql"/>
			<then>
				<exec executable="sqlcmd" output="${va.web.folder.logs}\console_${touch.time}_procedures.log" append="true">  
				<arg line="-S ${db.servername} -U ${db.username} -P ${db.password} -d ${db.name} -i ${va.web.folder.output.scripts}\02.MAIN\03.procedures.sql -o ${va.web.folder.logs}\sqlprocedures.log" />
				</exec>	
			</then>        
		</if>
		
		<if>
			<available file="${va.web.folder.output.scripts}\02.MAIN\03.procedures.sql"/>
			<then>
				<exec executable="sqlcmd" output="${va.web.folder.logs}\console_${touch.time}_procedures.log" append="true">  
				<arg line="-S ${db.servername} -U ${db.username} -P ${db.password} -d ${db.name} -i ${va.web.folder.output.scripts}\02.MAIN\03.procedures.sql -o ${va.web.folder.logs}\sqlprocedures.log" />
				</exec>	
			</then>        
		</if>
		
		<if>
			<available file="${va.web.folder.output.scripts}\02.MAIN\04.triggers.sql"/>
			<then>
				<exec executable="sqlcmd" output="${va.web.folder.logs}\console_${touch.time}_triggers.log" append="true">  
				<arg line="-S ${db.servername} -U ${db.username} -P ${db.password} -d ${db.name} -i ${va.web.folder.output.scripts}\02.MAIN\04.triggers.sql -o ${va.web.folder.logs}\sqltriggers.log" />			
				</exec>
			</then>
		</if>
		
		<!-- Delete old logs -->
		<exec dir="${jenkins.email.logs}" executable="PowerShell" failonerror="true">
			<arg line="Get-ChildItem | Remove-Item -Force"/>
		</exec>

		<!-- Copy logs of current build -->
		<copy todir="${jenkins.email.logs}">
			<fileset dir="${va.web.folder.logs}" excludes="console*" />
		</copy>

		<!-- Remove empty logs and logs with output message "(n rows affected)" -->
		<exec executable="PowerShell" dir="${jenkins.email.logs}" failonerror="true"> 
			<arg value="$Files = Get-ChildItem;" /> 
			<arg value="foreach($File in $Files){" /> 
			<arg value="	$Content = Get-Content -Raw -Path $File.FullName;" /> 
			<arg value="	if(($Content -match '(?s)^(\s*\(\d+ rows affected\)\s*)+$') -or ($File.Length -eq 0)){" />  
			<arg value="		Remove-Item -Path $File.FullName -Force;" /> 
			<arg value="	}" /> 
			<arg value="}" /> 
		</exec>

		<!-- Throw error if SQL scripts output have errors -->
		<exec executable="PowerShell" dir="${jenkins.email.logs}" failonerror="true"> 
			<arg value="if((Get-ChildItem | ? Name -like '*sql*').Count -gt 0){throw '~~~~~~~~~~~~~~~~~~~~~ Error(s) in DB Scripts ~~~~~~~~~~~~~~~~~~~~~'}" /> 
		</exec>
		
		
	</target>
	
</project>
